(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{383:function(e,t,a){"use strict";a.r(t);var s=a(42),n=Object(s.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"package"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#package"}},[e._v("#")]),e._v(" Package")]),e._v(" "),a("p",[e._v("Packaging applications should follow the "),a("code",[e._v("NPM")]),e._v(" style:")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[e._v("npm")]),e._v(" pack\n")])])]),a("p",[a("a",{attrs:{href:"https://docs.npmjs.com/cli/pack",target:"_blank",rel:"noopener noreferrer"}},[e._v("npm pack"),a("OutboundLink")],1),e._v(" will produce a "),a("code",[e._v("TGZ")]),e._v(" with your application which you can move to other\nlocation. However applications can also be "),a("a",{attrs:{href:"https://docs.npmjs.com/cli/publish",target:"_blank",rel:"noopener noreferrer"}},[e._v("published"),a("OutboundLink")],1),e._v(" to a NPM registry.")]),e._v(" "),a("p",[e._v("It is important to notice that in order to work with "),a("code",[e._v("published/packed")]),e._v(" the target environment needs to have access to\nthe package "),a("a",{attrs:{href:"https://www.npmjs.com/package/@es4x/create",target:"_blank",rel:"noopener noreferrer"}},[e._v("@es4x/create"),a("OutboundLink")],1),e._v(" as it will be required to install the "),a("code",[e._v("java")]),e._v(" bits.")]),e._v(" "),a("h2",{attrs:{id:"docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker"}},[e._v("#")]),e._v(" Docker")]),e._v(" "),a("p",[e._v("Docker images can also be created for you for.")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("es4x dockerfile\n")])])]),a("p",[e._v("This will produce a simple "),a("code",[e._v("dockerfile")]),e._v(" that you can customize to your needs, by default the file will be a 3 stage\nbuild.")]),e._v(" "),a("ol",[a("li",[e._v("On the first stage "),a("code",[e._v("node")]),e._v(" is used to install all "),a("code",[e._v("NPM")]),e._v(" dependencies")]),e._v(" "),a("li",[e._v("On the second stage "),a("code",[e._v("java")]),e._v(" is used to install the "),a("code",[e._v("Maven")]),e._v(" dependencies")]),e._v(" "),a("li",[e._v("On the final stage the GraalVM image is used to run the application")])]),e._v(" "),a("p",[e._v("By default "),a("a",{attrs:{href:"https://hub.docker.com/r/oracle/graalvm-ce",target:"_blank",rel:"noopener noreferrer"}},[e._v("oracle/graalvm-ce"),a("OutboundLink")],1),e._v(" docker image is used, but it can be replace\nwith any other JDK image (please prefer versions 11 or above) with support for JVMCI.")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("docker build "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(".")]),e._v(" --build-arg "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("BASEIMAGE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("openjdk:11\n")])])]),a("h2",{attrs:{id:"jlink"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jlink"}},[e._v("#")]),e._v(" JLink")]),e._v(" "),a("p",[e._v("Java 11 supports "),a("a",{attrs:{href:"https://docs.oracle.com/en/java/javase/11/tools/jlink.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("jlink"),a("OutboundLink")],1),e._v(". You can use the jlink tool to\nassemble and optimize a set of modules and their dependencies into a custom runtime image.")]),e._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[e._v("es4x jlink\n")])])]),a("p",[e._v("This will produce a "),a("strong",[e._v("optimized")]),e._v(" runtime, which means it can be used instead of relying on a full JDK installation.\nAs comparision, a hello world application will produce a runtime weighting about "),a("strong",[e._v("80Mb")]),e._v(", while a full JDK installation\nrequires around "),a("strong",[e._v("200Mb")]),e._v(".")]),e._v(" "),a("p",[e._v("This feature can be using in collaboration with "),a("code",[e._v("Dockerfile")]),e._v(". Instead of using the graal base image, use the "),a("code",[e._v("OpenJDK")]),e._v("\nbase image. Then on the second stage, run jlink:")]),e._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Second stage (build the JVM related code)")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" openjdk"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("11 AS JVM\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ARG")]),e._v(" ES4X_VERSION=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("project.version"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# force es4x maven resolution only to consider production dependencies")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ENV")]),e._v(" ES4X_ENV=production\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Copy the previous build step")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COPY")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("from=NPM /usr/src/app /usr/src/app\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# use the copied workspace")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("WORKDIR")]),e._v(" /usr/src/app\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Download the ES4X runtime tool")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" curl "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("sL https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("//github.com/reactiverse/es4x/releases/download/$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("ES4X_VERSION"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("/es4x"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("pm"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("ES4X_VERSION"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("bin.tar.gz "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("|")]),e._v(" \\\n    tar zx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("strip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("components=1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("C /usr/local\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Install the Java Dependencies")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" es4x install "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("f\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Create the optimized runtime")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" es4x jlink "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("t /usr/local\n")])])]),a("p",[e._v("This will produce the optimized runtime to jre, which can be used with a small base image for the final stage:")]),e._v(" "),a("div",{staticClass:"language-dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" debian"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("slim\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Collect the jars from the previous step")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COPY")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("from=JVM /usr/local /usr/local\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COPY")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("from=JVM /usr/src/app /usr/src/app\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# use the copied workspace")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("WORKDIR")]),e._v(" /usr/src/app\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Bundle app source")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COPY")]),e._v(" . .\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Define custom java options for containers")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ENV")]),e._v(" JAVA_OPTS="),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:+UseContainerSupport"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# define the entrypoint")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ENTRYPOINT")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"./node_modules/.bin/es4x-launcher"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("\n")])])]),a("p",[e._v("This will produce a small final image, but a larger layer as you're packaging the optimized runtime too.")])])}),[],!1,null,null,null);t.default=n.exports}}]);