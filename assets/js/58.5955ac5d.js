(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{340:function(e,s,t){"use strict";t.r(s);var a=t(13),n=Object(a.a)({},(function(){var e=this,s=e._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"package"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#package"}},[e._v("#")]),e._v(" Package")]),e._v(" "),s("p",[e._v("Packaging applications should follow the "),s("code",[e._v("NPM")]),e._v(" style:")]),e._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("npm")]),e._v(" pack\n")])])]),s("p",[s("a",{attrs:{href:"https://docs.npmjs.com/cli/pack",target:"_blank",rel:"noopener noreferrer"}},[e._v("npm pack"),s("OutboundLink")],1),e._v(" will produce a "),s("code",[e._v("TGZ")]),e._v(" with your application which you can move to other\nlocation. However applications can also be "),s("a",{attrs:{href:"https://docs.npmjs.com/cli/publish",target:"_blank",rel:"noopener noreferrer"}},[e._v("published"),s("OutboundLink")],1),e._v(" to a NPM registry.")]),e._v(" "),s("p",[e._v("It is important to notice that in order to work with "),s("code",[e._v("published/packed")]),e._v(" the target environment needs to have access to\nthe package "),s("a",{attrs:{href:"https://www.npmjs.com/package/@es4x/create",target:"_blank",rel:"noopener noreferrer"}},[e._v("@es4x/create"),s("OutboundLink")],1),e._v(" as it will be required to install the "),s("code",[e._v("java")]),e._v(" bits.")]),e._v(" "),s("h2",{attrs:{id:"docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker"}},[e._v("#")]),e._v(" Docker")]),e._v(" "),s("p",[e._v("Docker images can also be created for you for.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("es4x dockerfile\n")])])]),s("p",[e._v("This will produce a simple "),s("code",[e._v("dockerfile")]),e._v(" that you can customize to your needs, by default the file will be a 3 stage\nbuild.")]),e._v(" "),s("ol",[s("li",[e._v("On the first stage "),s("code",[e._v("node")]),e._v(" is used to install all "),s("code",[e._v("NPM")]),e._v(" dependencies")]),e._v(" "),s("li",[e._v("On the second stage "),s("code",[e._v("java")]),e._v(" is used to install the "),s("code",[e._v("Maven")]),e._v(" dependencies")]),e._v(" "),s("li",[e._v("On the final stage the GraalVM image is used to run the application")])]),e._v(" "),s("p",[e._v("By default "),s("a",{attrs:{href:"https://hub.docker.com/r/oracle/graalvm-ce",target:"_blank",rel:"noopener noreferrer"}},[e._v("oracle/graalvm-ce"),s("OutboundLink")],1),e._v(" docker image is used, but it can be replace\nwith any other JDK image (please prefer versions 11 or above) with support for JVMCI.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("docker")]),e._v(" build "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(".")]),e._v(" --build-arg "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("BASEIMAGE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("openjdk:11\n")])])]),s("h2",{attrs:{id:"jlink"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#jlink"}},[e._v("#")]),e._v(" JLink")]),e._v(" "),s("p",[e._v("Java 11 supports "),s("a",{attrs:{href:"https://docs.oracle.com/en/java/javase/11/tools/jlink.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("jlink"),s("OutboundLink")],1),e._v(". You can use the jlink tool to\nassemble and optimize a set of modules and their dependencies into a custom runtime image.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("es4x jlink\n")])])]),s("p",[e._v("This will produce a "),s("strong",[e._v("optimized")]),e._v(" runtime, which means it can be used instead of relying on a full JDK installation.\nAs comparision, a hello world application will produce a runtime weighting about "),s("strong",[e._v("80Mb")]),e._v(", while a full JDK installation\nrequires around "),s("strong",[e._v("200Mb")]),e._v(".")]),e._v(" "),s("p",[e._v("This feature can be using in collaboration with "),s("code",[e._v("Dockerfile")]),e._v(". Instead of using the graal base image, use the "),s("code",[e._v("OpenJDK")]),e._v("\nbase image. Then on the second stage, run jlink:")]),e._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Second stage (build the JVM related code)")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" openjdk:11 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("AS")]),e._v(" JVM")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ARG")]),e._v(" ES4X_VERSION="),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${project.version}")])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Copy the previous build step")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COPY")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token options"}},[s("span",{pre:!0,attrs:{class:"token property"}},[e._v("--from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("NPM")])]),e._v(" /usr/src/app /usr/src/app")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# use the copied workspace")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("WORKDIR")]),e._v(" /usr/src/app")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Download the ES4X runtime tool")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" curl -sL https://github.com/reactiverse/es4x/releases/download/"),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${ES4X_VERSION}")]),e._v("/es4x-pm-"),s("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${ES4X_VERSION}")]),e._v("-bin.tar.gz | "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("\\")]),e._v("\n    tar zx --strip-components=1 -C /usr/local")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Install the Java Dependencies")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# force es4x maven resolution only to consider production dependencies")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" es4x install --only=prod")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Create the optimized runtime")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RUN")]),e._v(" es4x jlink -t /usr/local")]),e._v("\n")])])]),s("p",[e._v("This will produce the optimized runtime to jre, which can be used with a small base image for the final stage:")]),e._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FROM")]),e._v(" debian:slim")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Collect the jars from the previous step")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COPY")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token options"}},[s("span",{pre:!0,attrs:{class:"token property"}},[e._v("--from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("JVM")])]),e._v(" /usr/local /usr/local")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COPY")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token options"}},[s("span",{pre:!0,attrs:{class:"token property"}},[e._v("--from")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("JVM")])]),e._v(" /usr/src/app /usr/src/app")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# use the copied workspace")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("WORKDIR")]),e._v(" /usr/src/app")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Bundle app source")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("COPY")]),e._v(" . .")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Define custom java options for containers")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ENV")]),e._v(" JAVA_OPTS="),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:+UseContainerSupport"')])]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# define the entrypoint")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("ENTRYPOINT")]),e._v(" [ "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"./node_modules/.bin/es4x-launcher"')]),e._v(" ]")]),e._v("\n")])])]),s("p",[e._v("This will produce a small final image, but a larger layer as you're packaging the optimized runtime too.")])])}),[],!1,null,null,null);s.default=n.exports}}]);